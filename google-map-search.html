<!-- Copyright (c) 2015 Google Inc. All rights reserved. -->

<link rel="import" href="../polymer/polymer.html">


<script>
/**
Provides Google Maps Places API functionality.

See https://developers.google.com/maps/documentation/javascript/places for more
information on the API.

#### Example:

    <template is="dom-bind">
      <google-map-search map="{{map}}" query="Pizza" currentMapArea
                         results="{{results}}"></google-map-search>
      <google-map map="{{map}}" latitude="37.779"
                  longitude="-122.3892">
        <template repeat="{{results}}">
          <google-map-marker latitude="{{latitude}}"
                             longitude="{{longitude}}">
            <h2>{{name}}</h2>
            {{formatted_address}}
          </google-map-marker>
        </template>
      </google-map>
    </template>
    <script>
      document.querySelector('google-map-search').search();
    < /script>

*/
  Polymer({

    is: 'google-map-search',

/**
Fired when the search element returns a result.

@event google-map-search-results
@param {Array} detail An array of search results
  @param {number} detail.latitude Latitude of the result.
  @param {number} detail.longitude Longitude of the result.
  @param {bool} detail.show Whether to show the result on the map.
*/
    properties: {

      /**
       * The Google map object.
       */
      map: {
        type: Object,
        value: null
      },

      /**
       * The search query.
       */
      query: {
        type: String,
        value: null
      },

      /**
       * Restrict the search only to the current map area.
       *
       * @attribute currentMapArea
       */
      currentMapArea: {
        type: Boolean,
        value: true
      }

      /**
       * Space-separated list of result types.
       * The search will only return results of the listed types.
       * See https://developers.google.com/places/documentation/supported_types
       * for a list of supported types.
       * Leave empty or null to search for all result types.
       */
      types: {
        type: String,
        value: null
      } 

      /**
       * The search results.
       */
      results: {
        type: Array,
        value: null,
        notify: true
      }
    },

    observers: [
      'search(query,map,types,currentMapArea)'
    ],

    /**
     * Perform a search using for `query` for the search term.
     *
     * @method search
     */
    search: function() {
      if (this.query && this.map) {
        var places = new google.maps.places.PlacesService(this.map);
        var types = this.types && typeof this.types == 'string' ?
                    this.types.split(' ') : null;

        places.textSearch({
          query: this.query,
          types: types,
          bounds: this.currentMapArea ? this.map.getBounds() : null
        }, this._gotResults.bind(this));
      }
    },

    _gotResults: function(results, status) {
      this.results = results.map(function(result) {
        // obtain lat/long from geometry
        result.latitude  = result.geometry.location.lat();
        result.longitude = result.geometry.location.lng();

        return result;
      });
      this.fire('google-map-search-results', this.results);
    }
  });
</script>
